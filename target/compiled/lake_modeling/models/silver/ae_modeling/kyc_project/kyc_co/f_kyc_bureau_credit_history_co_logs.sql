
-- SILVER SQL

-- SECTION 1 -> CALLING BRONCE ref's
WITH
prospectbureaucredithistoryobtained_co AS ( 
    SELECT *
    FROM bronze.prospectbureaucredithistoryobtained_co
    WHERE ocurred_on_date BETWEEN (to_date('2022-01-01'- INTERVAL "10" HOUR)) AND to_date('2022-01-30') AND
        ocurred_on BETWEEN (to_timestamp('2022-01-01'- INTERVAL "10" HOUR)) AND to_timestamp('2022-01-30') 
)


--SECTION 1B -> UNION BRONCE ref's
, union_bronze AS (
    SELECT 
        application_id,client_id,commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_balance,commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_closedAccounts,commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_creditUtilizationRatio,commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_initialApprovedAmount,commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_installmentAmount,commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_maximumDelinquency,commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_openedAccounts,commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_rating,commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_score,commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_totalClosedAccounts,commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_totalOpenedAccounts,commercial_commercialSummaryExperian_summary_balance_delinquent30Balance,commercial_commercialSummaryExperian_summary_balance_delinquent60Balance,commercial_commercialSummaryExperian_summary_balance_delinquent90Balance,commercial_commercialSummaryExperian_summary_balance_delinquentBalance,commercial_commercialSummaryExperian_summary_balance_higherBalance,commercial_commercialSummaryExperian_summary_balance_installmentAmount,commercial_commercialSummaryExperian_summary_balance_totalBalance,commercial_commercialSummaryExperian_summary_principal_claims,commercial_commercialSummaryExperian_summary_principal_closedAccounts,commercial_commercialSummaryExperian_summary_principal_closedAccountsAHOCCB,commercial_commercialSummaryExperian_summary_principal_customerSince,commercial_commercialSummaryExperian_summary_principal_disagreementsToDate,commercial_commercialSummaryExperian_summary_principal_lastSixMonthsQueries,commercial_commercialSummaryExperian_summary_principal_negativeHistoryLastTwelveMonths,commercial_commercialSummaryExperian_summary_principal_negativeOpenAccounts,commercial_commercialSummaryExperian_summary_principal_openAccounts,commercial_commercialSummaryExperian_summary_principal_openAccountsAHOCCB,commercial_incomeEstimator_averageSMLV,commercial_incomeEstimator_creditCardBalance,commercial_incomeEstimator_creditCardInitialApprovedAmount,commercial_incomeEstimator_creditCardInstallment,commercial_incomeEstimator_estimatedIncome,commercial_incomeEstimator_indebtednessCapacity,commercial_incomeEstimator_maximum,commercial_incomeEstimator_maximumSMLV,commercial_incomeEstimator_minimum,commercial_incomeEstimator_minimumSMLV,commercial_incomeEstimator_nonRevolvingTotalBalance,commercial_incomeEstimator_nonRevolvingTotalInitialApprovedAmount,commercial_incomeEstimator_nonRevolvingTotalInstallment,commercial_incomeEstimator_nonRevolvingTotalProducts,commercial_incomeEstimator_paymentCapacity,commercial_incomeEstimator_totalActiveCreditCards,commercial_incomeEstimator_totalActiveProducts,commercial_incomeEstimator_totalBalance,commercial_incomeEstimator_totalInitialApprovedAmount,commercial_incomeEstimator_totalInstallment,commercial_incomeValidator_healthEntity,commercial_incomeValidator_pensionFundName,commercial_indebtednessSummary_quarter1_date,commercial_indebtednessSummary_quarter1_numberOfEntities,commercial_indebtednessSummary_quarter1_numberOfPurchases,commercial_indebtednessSummary_quarter1_numberOfRefinanced,commercial_indebtednessSummary_quarter1_numberOfWriteOffs,commercial_indebtednessSummary_quarter2_date,commercial_indebtednessSummary_quarter2_numberOfEntities,commercial_indebtednessSummary_quarter2_numberOfPurchases,commercial_indebtednessSummary_quarter2_numberOfRefinanced,commercial_indebtednessSummary_quarter2_numberOfWriteOffs,commercial_indebtednessSummary_quarter3_date,commercial_indebtednessSummary_quarter3_numberOfEntities,commercial_indebtednessSummary_quarter3_numberOfPurchases,commercial_indebtednessSummary_quarter3_numberOfRefinanced,commercial_indebtednessSummary_quarter3_numberOfWriteOffs,commercial_provider,metadata_context_traceId,ocurred_on,
    event_name,
    event_id
    FROM prospectbureaucredithistoryobtained_co
    
) 
-- SECTION 2 -> UNION of prepared CTE's in Section 1
, union_all_events AS (
    SELECT 
    application_id,client_id,commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_balance,commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_closedAccounts,commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_creditUtilizationRatio,commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_initialApprovedAmount,commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_installmentAmount,commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_maximumDelinquency,commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_openedAccounts,commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_rating,commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_score,commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_totalClosedAccounts,commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_totalOpenedAccounts,commercial_commercialSummaryExperian_summary_balance_delinquent30Balance,commercial_commercialSummaryExperian_summary_balance_delinquent60Balance,commercial_commercialSummaryExperian_summary_balance_delinquent90Balance,commercial_commercialSummaryExperian_summary_balance_delinquentBalance,commercial_commercialSummaryExperian_summary_balance_higherBalance,commercial_commercialSummaryExperian_summary_balance_installmentAmount,commercial_commercialSummaryExperian_summary_balance_totalBalance,commercial_commercialSummaryExperian_summary_principal_claims,commercial_commercialSummaryExperian_summary_principal_closedAccounts,commercial_commercialSummaryExperian_summary_principal_closedAccountsAHOCCB,commercial_commercialSummaryExperian_summary_principal_customerSince,commercial_commercialSummaryExperian_summary_principal_disagreementsToDate,commercial_commercialSummaryExperian_summary_principal_lastSixMonthsQueries,commercial_commercialSummaryExperian_summary_principal_negativeHistoryLastTwelveMonths,commercial_commercialSummaryExperian_summary_principal_negativeOpenAccounts,commercial_commercialSummaryExperian_summary_principal_openAccounts,commercial_commercialSummaryExperian_summary_principal_openAccountsAHOCCB,commercial_incomeEstimator_averageSMLV,commercial_incomeEstimator_creditCardBalance,commercial_incomeEstimator_creditCardInitialApprovedAmount,commercial_incomeEstimator_creditCardInstallment,commercial_incomeEstimator_estimatedIncome,commercial_incomeEstimator_indebtednessCapacity,commercial_incomeEstimator_maximum,commercial_incomeEstimator_maximumSMLV,commercial_incomeEstimator_minimum,commercial_incomeEstimator_minimumSMLV,commercial_incomeEstimator_nonRevolvingTotalBalance,commercial_incomeEstimator_nonRevolvingTotalInitialApprovedAmount,commercial_incomeEstimator_nonRevolvingTotalInstallment,commercial_incomeEstimator_nonRevolvingTotalProducts,commercial_incomeEstimator_paymentCapacity,commercial_incomeEstimator_totalActiveCreditCards,commercial_incomeEstimator_totalActiveProducts,commercial_incomeEstimator_totalBalance,commercial_incomeEstimator_totalInitialApprovedAmount,commercial_incomeEstimator_totalInstallment,commercial_incomeValidator_healthEntity,commercial_incomeValidator_pensionFundName,commercial_indebtednessSummary_quarter1_date,commercial_indebtednessSummary_quarter1_numberOfEntities,commercial_indebtednessSummary_quarter1_numberOfPurchases,commercial_indebtednessSummary_quarter1_numberOfRefinanced,commercial_indebtednessSummary_quarter1_numberOfWriteOffs,commercial_indebtednessSummary_quarter2_date,commercial_indebtednessSummary_quarter2_numberOfEntities,commercial_indebtednessSummary_quarter2_numberOfPurchases,commercial_indebtednessSummary_quarter2_numberOfRefinanced,commercial_indebtednessSummary_quarter2_numberOfWriteOffs,commercial_indebtednessSummary_quarter3_date,commercial_indebtednessSummary_quarter3_numberOfEntities,commercial_indebtednessSummary_quarter3_numberOfPurchases,commercial_indebtednessSummary_quarter3_numberOfRefinanced,commercial_indebtednessSummary_quarter3_numberOfWriteOffs,commercial_provider,metadata_context_traceId,ocurred_on,
    event_name,
    event_id
    FROM union_bronze 
    
)   



, final AS (
    SELECT 
        *,
        date(ocurred_on ) as ocurred_on_date,
        to_timestamp('2022-01-01') updated_at
    FROM union_all_events 
)

select * from final;

/* DEBUGGING SECTION
is_incremental: True
this: silver.f_kyc_bureau_credit_history_co_logs
country: co
silver_table_name: f_kyc_bureau_credit_history_co_logs
table_pk_fields: ['event_id']
table_pk_amount: 1
fields_direct: ['application_id', 'client_id', 'commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_balance', 'commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_closedAccounts', 'commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_creditUtilizationRatio', 'commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_initialApprovedAmount', 'commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_installmentAmount', 'commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_maximumDelinquency', 'commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_openedAccounts', 'commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_rating', 'commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_score', 'commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_totalClosedAccounts', 'commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_totalOpenedAccounts', 'commercial_commercialSummaryExperian_summary_balance_delinquent30Balance', 'commercial_commercialSummaryExperian_summary_balance_delinquent60Balance', 'commercial_commercialSummaryExperian_summary_balance_delinquent90Balance', 'commercial_commercialSummaryExperian_summary_balance_delinquentBalance', 'commercial_commercialSummaryExperian_summary_balance_higherBalance', 'commercial_commercialSummaryExperian_summary_balance_installmentAmount', 'commercial_commercialSummaryExperian_summary_balance_totalBalance', 'commercial_commercialSummaryExperian_summary_principal_claims', 'commercial_commercialSummaryExperian_summary_principal_closedAccounts', 'commercial_commercialSummaryExperian_summary_principal_closedAccountsAHOCCB', 'commercial_commercialSummaryExperian_summary_principal_customerSince', 'commercial_commercialSummaryExperian_summary_principal_disagreementsToDate', 'commercial_commercialSummaryExperian_summary_principal_lastSixMonthsQueries', 'commercial_commercialSummaryExperian_summary_principal_negativeHistoryLastTwelveMonths', 'commercial_commercialSummaryExperian_summary_principal_negativeOpenAccounts', 'commercial_commercialSummaryExperian_summary_principal_openAccounts', 'commercial_commercialSummaryExperian_summary_principal_openAccountsAHOCCB', 'commercial_incomeEstimator_averageSMLV', 'commercial_incomeEstimator_creditCardBalance', 'commercial_incomeEstimator_creditCardInitialApprovedAmount', 'commercial_incomeEstimator_creditCardInstallment', 'commercial_incomeEstimator_estimatedIncome', 'commercial_incomeEstimator_indebtednessCapacity', 'commercial_incomeEstimator_maximum', 'commercial_incomeEstimator_maximumSMLV', 'commercial_incomeEstimator_minimum', 'commercial_incomeEstimator_minimumSMLV', 'commercial_incomeEstimator_nonRevolvingTotalBalance', 'commercial_incomeEstimator_nonRevolvingTotalInitialApprovedAmount', 'commercial_incomeEstimator_nonRevolvingTotalInstallment', 'commercial_incomeEstimator_nonRevolvingTotalProducts', 'commercial_incomeEstimator_paymentCapacity', 'commercial_incomeEstimator_totalActiveCreditCards', 'commercial_incomeEstimator_totalActiveProducts', 'commercial_incomeEstimator_totalBalance', 'commercial_incomeEstimator_totalInitialApprovedAmount', 'commercial_incomeEstimator_totalInstallment', 'commercial_incomeValidator_healthEntity', 'commercial_incomeValidator_pensionFundName', 'commercial_indebtednessSummary_quarter1_date', 'commercial_indebtednessSummary_quarter1_numberOfEntities', 'commercial_indebtednessSummary_quarter1_numberOfPurchases', 'commercial_indebtednessSummary_quarter1_numberOfRefinanced', 'commercial_indebtednessSummary_quarter1_numberOfWriteOffs', 'commercial_indebtednessSummary_quarter2_date', 'commercial_indebtednessSummary_quarter2_numberOfEntities', 'commercial_indebtednessSummary_quarter2_numberOfPurchases', 'commercial_indebtednessSummary_quarter2_numberOfRefinanced', 'commercial_indebtednessSummary_quarter2_numberOfWriteOffs', 'commercial_indebtednessSummary_quarter3_date', 'commercial_indebtednessSummary_quarter3_numberOfEntities', 'commercial_indebtednessSummary_quarter3_numberOfPurchases', 'commercial_indebtednessSummary_quarter3_numberOfRefinanced', 'commercial_indebtednessSummary_quarter3_numberOfWriteOffs', 'commercial_provider', 'event_id', 'metadata_context_traceId', 'ocurred_on']
mandatory_fields: ['event_name', 'event_id']
events_dict: {'prospectbureaucredithistoryobtained': {'direct_attributes': ['event_id', 'application_id', 'client_id', 'commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_balance', 'commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_closedAccounts', 'commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_creditUtilizationRatio', 'commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_initialApprovedAmount', 'commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_installmentAmount', 'commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_maximumDelinquency', 'commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_openedAccounts', 'commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_rating', 'commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_score', 'commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_totalClosedAccounts', 'commercial_commercialSummaryExperian_balanceEvolution_averageAnalysis_totalOpenedAccounts', 'commercial_commercialSummaryExperian_summary_balance_delinquent30Balance', 'commercial_commercialSummaryExperian_summary_balance_delinquent60Balance', 'commercial_commercialSummaryExperian_summary_balance_delinquent90Balance', 'commercial_commercialSummaryExperian_summary_balance_delinquentBalance', 'commercial_commercialSummaryExperian_summary_balance_higherBalance', 'commercial_commercialSummaryExperian_summary_balance_installmentAmount', 'commercial_commercialSummaryExperian_summary_balance_totalBalance', 'commercial_commercialSummaryExperian_summary_principal_claims', 'commercial_commercialSummaryExperian_summary_principal_closedAccounts', 'commercial_commercialSummaryExperian_summary_principal_closedAccountsAHOCCB', 'commercial_commercialSummaryExperian_summary_principal_customerSince', 'commercial_commercialSummaryExperian_summary_principal_disagreementsToDate', 'commercial_commercialSummaryExperian_summary_principal_lastSixMonthsQueries', 'commercial_commercialSummaryExperian_summary_principal_negativeHistoryLastTwelveMonths', 'commercial_commercialSummaryExperian_summary_principal_negativeOpenAccounts', 'commercial_commercialSummaryExperian_summary_principal_openAccounts', 'commercial_commercialSummaryExperian_summary_principal_openAccountsAHOCCB', 'commercial_incomeEstimator_averageSMLV', 'commercial_incomeEstimator_creditCardBalance', 'commercial_incomeEstimator_creditCardInitialApprovedAmount', 'commercial_incomeEstimator_creditCardInstallment', 'commercial_incomeEstimator_estimatedIncome', 'commercial_incomeEstimator_indebtednessCapacity', 'commercial_incomeEstimator_maximum', 'commercial_incomeEstimator_maximumSMLV', 'commercial_incomeEstimator_minimum', 'commercial_incomeEstimator_minimumSMLV', 'commercial_incomeEstimator_nonRevolvingTotalBalance', 'commercial_incomeEstimator_nonRevolvingTotalInitialApprovedAmount', 'commercial_incomeEstimator_nonRevolvingTotalInstallment', 'commercial_incomeEstimator_nonRevolvingTotalProducts', 'commercial_incomeEstimator_paymentCapacity', 'commercial_incomeEstimator_totalActiveCreditCards', 'commercial_incomeEstimator_totalActiveProducts', 'commercial_incomeEstimator_totalBalance', 'commercial_incomeEstimator_totalInitialApprovedAmount', 'commercial_incomeEstimator_totalInstallment', 'commercial_incomeValidator_healthEntity', 'commercial_incomeValidator_pensionFundName', 'commercial_indebtednessSummary_quarter1_date', 'commercial_indebtednessSummary_quarter1_numberOfEntities', 'commercial_indebtednessSummary_quarter1_numberOfPurchases', 'commercial_indebtednessSummary_quarter1_numberOfRefinanced', 'commercial_indebtednessSummary_quarter1_numberOfWriteOffs', 'commercial_indebtednessSummary_quarter2_date', 'commercial_indebtednessSummary_quarter2_numberOfEntities', 'commercial_indebtednessSummary_quarter2_numberOfPurchases', 'commercial_indebtednessSummary_quarter2_numberOfRefinanced', 'commercial_indebtednessSummary_quarter2_numberOfWriteOffs', 'commercial_indebtednessSummary_quarter3_date', 'commercial_indebtednessSummary_quarter3_numberOfEntities', 'commercial_indebtednessSummary_quarter3_numberOfPurchases', 'commercial_indebtednessSummary_quarter3_numberOfRefinanced', 'commercial_indebtednessSummary_quarter3_numberOfWriteOffs', 'commercial_provider', 'metadata_context_traceId', 'ocurred_on'], 'custom_attributes': {}}}
events_keys: ['prospectbureaucredithistoryobtained']
flag_group_feature_active: False
version: silver_sql_builder_alternative
*/
